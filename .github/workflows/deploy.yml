name: ▶️ CI/CD Pipeline

on:
  ## 本番環境ではpushの3行を使用する
  # push:
  #   branches:
  #     - main
  ## 開発のみでは以下のworkflow_dispatchの6行を使用する
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm the action.'
        required: true
        default: 'NO'

jobs:
  deploy:
    ## 本番環境ではifの行は削除する事。onのpushの3行を使用し、自動実行を有効にする。
    # ユーザーが "DEPLOY" と入力した場合のみ実行
    if: github.event.inputs.confirm == 'DEPLOY'
    runs-on: ubuntu-latest
    
    permissions: # OIDC認証に必要な権限
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWS認証情報の取得 (OIDC認証)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      # ----------------------------------------------------
      # 【修正箇所 1】コアインフラ構築をDocker操作の前に実行
      # ----------------------------------------------------

      # 2. Terraform実行環境のセットアップ (元のステップ7を移動)
      - name: Setup Terraform (Core Infra)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      # 3. Terraform Init の実行 (元のステップ8を移動)
      - name: Terraform Init (Core Infra)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: terraform init
        working-directory: ./infra
      
      # 4. Terraform Apply (コアインフラ構築: ECR, SQSなど) の実行 (新規追加)
      # Docker Pushに必要なECRリポジトリと、W4-D16のタスクに必要なSQSキューを先に作成します。
      # -target は、既に存在しているリソースのエラー（前回発生したTarget Groupなどのエラー）を一時的に回避するためにも有効です。
      - name: Terraform Apply (Core Infra ECR, SQS)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: |
          echo "Applying core infrastructure: ECR and SQS..."
          terraform apply -auto-approve -input=false
        working-directory: ./infra
      
      # ----------------------------------------------------
      # 【修正箇所 2】アプリケーションのビルド・デプロイ (ECRが存在するため成功する)
      # ----------------------------------------------------
      
      # 5. ECRへのログイン（元ステップ2）
      - name: Login to Amazon ECR
        id: login-ecr 
        uses: aws-actions/amazon-ecr-login@v2

      # 6. Go環境のセットアップ（元ステップ3）
      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'

      # 7. アプリケーションのテスト（元ステップ4）
      - name: Run Unit Tests
        run: go test -v ./...
        
      # 8. Dockerイメージのビルド、タグ付け、およびECRへのプッシュ（元ステップ5&6）
      # ECRリポジトリがステップ4で作成されているため、このステップは成功します。
      - name: Build, tag, and push docker image to Amazon ECR
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building image with tag: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
        
          echo "Pushing image to ECR..."
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          
      # ----------------------------------------------------
      # 【修正箇所 3】ECSサービス更新 (Terraform Plan & Apply)
      # ----------------------------------------------------

      # 9. Terraform Plan の実行 (ECSタスク定義のイメージURIを更新) (元ステップ9)
      - name: Terraform Plan (Service Update)
        id: plan
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: |
          IMAGE_URI="$REGISTRY/$REPOSITORY:$IMAGE_TAG"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
          # app_image_uri変数を使用して、ECSタスク定義のイメージURIを更新するPlanを作成
          terraform plan -no-color -input=false \
            -var="app_image_uri=$IMAGE_URI" \
            -out=tfplan
        working-directory: ./infra

      # 10. Terraform Apply の実行 (ECSサービスの更新) (元ステップ10)
      - name: Terraform Apply (Service Update)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        # 作成したPlanファイルを適用し、ECSサービスをデプロイ
        run: terraform apply -auto-approve -input=false tfplan
        working-directory: ./infra