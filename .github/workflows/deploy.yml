name: ğŸš¨ CI/CD Pipeline

# 20251211byKota å¤§å¹…ä¿®æ­£2

on:
  ## æœ¬ç•ªç’°å¢ƒã§ã¯pushã®3è¡Œã‚’ä½¿ç”¨ã™ã‚‹
  # push:
  #   branches:
  #     - main
  ## é–‹ç™ºã®ã¿ã§ã¯ä»¥ä¸‹ã®workflow_dispatchã®6è¡Œã‚’ä½¿ç”¨ã™ã‚‹
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã¯å¯èƒ½ã®ã¾ã¾
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm the action.'
        required: true
        default: 'NO'

jobs:
  deploy:
    ## æœ¬ç•ªç’°å¢ƒã§ã¯ifã®è¡Œã¯å‰Šé™¤ã™ã‚‹äº‹ã€‚onã®pushã®3è¡Œã‚’ä½¿ç”¨ã—ã€è‡ªå‹•å®Ÿè¡Œã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "DEPLOY" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'DEPLOY'
    runs-on: ubuntu-latest
    
    permissions: # OIDCèªè¨¼ã«å¿…è¦ãªæ¨©é™
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWSèªè¨¼æƒ…å ±ã®å–å¾— (OIDCèªè¨¼)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      # ----------------------------------------------------
      # ã€ä¿®æ­£ç®‡æ‰€ 1ã€‘ã‚³ã‚¢ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’Dockeræ“ä½œã®å‰ã«å®Ÿè¡Œ
      # ----------------------------------------------------

      # 2. Terraformå®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (å…ƒã®ã‚¹ãƒ†ãƒƒãƒ—7ã‚’ç§»å‹•)
      - name: Setup Terraform (Core Infra)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      # 3. Terraform Init ã®å®Ÿè¡Œ (å…ƒã®ã‚¹ãƒ†ãƒƒãƒ—8ã‚’ç§»å‹•)
      - name: Terraform Init (Core Infra)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: terraform init
        working-directory: ./infra
      
      # 4. Terraform Apply (ã‚³ã‚¢ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰: ECR, SQSãªã©) ã®å®Ÿè¡Œ (æ–°è¦è¿½åŠ )
      # Docker Pushã«å¿…è¦ãªECRãƒªãƒã‚¸ãƒˆãƒªã¨ã€W4-D16ã®ã‚¿ã‚¹ã‚¯ã«å¿…è¦ãªSQSã‚­ãƒ¥ãƒ¼ã‚’å…ˆã«ä½œæˆã—ã¾ã™ã€‚
      # -target ã¯ã€æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ï¼ˆå‰å›ç™ºç”Ÿã—ãŸTarget Groupãªã©ã®ã‚¨ãƒ©ãƒ¼ï¼‰ã‚’ä¸€æ™‚çš„ã«å›é¿ã™ã‚‹ãŸã‚ã«ã‚‚æœ‰åŠ¹ã§ã™ã€‚
      - name: Terraform Apply (Core Infra: ECR, SQS)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: |
          echo "Applying core infrastructure: ECR and SQS..."
          # ECR, SQSã‚­ãƒ¥ãƒ¼ã€DLQã‚’ä½œæˆ/æ›´æ–°ã€‚ãƒªã‚½ãƒ¼ã‚¹åã¯ã”è‡ªèº«ã®infraã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚
          terraform apply -auto-approve -input=false \
            -target=aws_ecr_repository.main \
            -target=aws_sqs_queue.task_notification_queue \
            -target=aws_sqs_queue.task_notification_dlq
        working-directory: ./infra
      
      # ----------------------------------------------------
      # ã€ä¿®æ­£ç®‡æ‰€ 2ã€‘ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ (ECRãŒå­˜åœ¨ã™ã‚‹ãŸã‚æˆåŠŸã™ã‚‹)
      # ----------------------------------------------------
      
      # 5. ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå…ƒã‚¹ãƒ†ãƒƒãƒ—2ï¼‰
      - name: Login to Amazon ECR
        id: login-ecr 
        uses: aws-actions/amazon-ecr-login@v2

      # 6. Goç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå…ƒã‚¹ãƒ†ãƒƒãƒ—3ï¼‰
      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'

      # 7. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆï¼ˆå…ƒã‚¹ãƒ†ãƒƒãƒ—4ï¼‰
      - name: Run Unit Tests
        run: go test -v ./...
        
      # 8. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã€ã‚¿ã‚°ä»˜ã‘ã€ãŠã‚ˆã³ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆå…ƒã‚¹ãƒ†ãƒƒãƒ—5&6ï¼‰
      # ECRãƒªãƒã‚¸ãƒˆãƒªãŒã‚¹ãƒ†ãƒƒãƒ—4ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯æˆåŠŸã—ã¾ã™ã€‚
      - name: Build, tag, and push docker image to Amazon ECR
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building image with tag: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
        
          echo "Pushing image to ECR..."
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          
      # ----------------------------------------------------
      # ã€ä¿®æ­£ç®‡æ‰€ 3ã€‘ECSã‚µãƒ¼ãƒ“ã‚¹æ›´æ–° (Terraform Plan & Apply)
      # ----------------------------------------------------
      
      # 9. Terraform Plan ã®å®Ÿè¡Œ (ECSã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¤ãƒ¡ãƒ¼ã‚¸URIã‚’æ›´æ–°) (å…ƒã‚¹ãƒ†ãƒƒãƒ—9)
      - name: Terraform Plan (Service Update)
        id: plan
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: |
          IMAGE_URI="$REGISTRY/$REPOSITORY:$IMAGE_TAG"
          
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
          # app_image_uriå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ECSã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¤ãƒ¡ãƒ¼ã‚¸URIã‚’æ›´æ–°ã™ã‚‹Planã‚’ä½œæˆ
          terraform plan -no-color -input=false \
            -var="app_image_uri=$IMAGE_URI" \
            -out=tfplan
        working-directory: ./infra

      # 10. Terraform Apply ã®å®Ÿè¡Œ (ECSã‚µãƒ¼ãƒ“ã‚¹ã®æ›´æ–°) (å…ƒã‚¹ãƒ†ãƒƒãƒ—10)
      - name: Terraform Apply (Service Update)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        # ä½œæˆã—ãŸPlanãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨ã—ã€ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
        run: terraform apply -auto-approve -input=false -var="app_image_uri=${{ env.IMAGE_URI }}" tfplan
        working-directory: ./infra