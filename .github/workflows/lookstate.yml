name: ğŸ‘€ Manual Look State Environment

on:
  workflow_dispatch: # â˜…æ‰‹å‹•ã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹â˜…
    inputs:
      confirm:
        description: 'Type "LOOKSTATE" to confirm the action. WARNING: This will look at the state of the infrastructure.'
        required: true
        default: 'NO'

jobs:
  lookstate:
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "LOOKSTATE" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'LOOKSTATE'
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    environment: production # ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šå¯èƒ½
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWSèªè¨¼æƒ…å ±ã®å–å¾— (OIDCèªè¨¼)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      # 2. Terraformå®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          
      # 3. Terraform Init ã®å®Ÿè¡Œ
      - name: Terraform Init
        run: terraform init
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}

      # 4. Terraform State List ã®å®Ÿè¡Œ
      # - name: List Remaining State Resources
      #   run: |
      #     echo "Listing resources remaining in the state file..."
      #     echo "--------------------------------"
      #     # state list ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
      #     terraform state list > state_list.txt
      #     # çµæœã‚’ãƒ­ã‚°ã«å‡ºåŠ›
      #     cat state_list.txt
      #     echo "--------------------------------"
      #     echo "End of state list"
      #   working-directory: ./infra

        # 4. Terraform State List ã®å®Ÿè¡Œ (â˜…ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¸€æ™‚çš„ã« State ä¿®æ­£ã«å¤‰æ›´ã—ã¾ã™â˜…)
      - name: TEMP: Perform State Import and Cleanup
        run: |
          echo "Performing final state synchronization and cleanup..."
          
          # ğŸš¨ 1. Instance Profileã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (Instance Profileã®è¡çªã‚’è§£æ¶ˆ)
          # IDã¯ AWSä¸Šã®ãƒªã‚½ãƒ¼ã‚¹åã‚’ä½¿ç”¨
          terraform import aws_iam_instance_profile.ssm_instance my-portfolio-2025-ssm-profile
          
          # ğŸš¨ 2. ä¸è¦ãªSQSã‚­ãƒ¥ãƒ¼ã‚’Stateã‹ã‚‰å‰Šé™¤ (Stateãƒªã‚¹ãƒˆã¨ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã‚’è§£æ¶ˆ)
          # ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ç¶šè¡Œã§ãã‚‹ã‚ˆã†ã« || true ã‚’è¿½åŠ 
          terraform state rm aws_sqs_queue.task_notification_queue || true
          terraform state rm aws_sqs_queue.task_notification_dlq || true

          echo "State manipulation complete. State file is now synced."
        working-directory: ./infra