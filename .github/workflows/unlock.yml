name: ğŸ”‘ Manual State Unlock (Temporary)

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨

jobs:
  unlock:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # deploy.ymlã‚„destroy.ymlã¨åŒã˜IAMãƒ­ãƒ¼ãƒ«ã®ARNã‚’æŒ‡å®š
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          
      - name: Terraform Init
        # â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: -lock=false ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ  â˜…â˜…â˜…
        run: terraform init -lock=false 
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
          
      # â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: Force Unlock ã¨ Destroy ã‚’çµ±åˆ â˜…â˜…â˜…
      - name: Force Unlock and Destroy Environment
        run: |
          # 1. ãƒ­ãƒƒã‚¯ã‚’å¼·åˆ¶è§£é™¤
          echo "Attempting to force unlock the state..."
          terraform force-unlock -force 3ae2ccf7-4724-be2b-400b-a17e00ac2b1c
          
          # 2. ãƒ­ãƒƒã‚¯è§£é™¤ã®ç¢ºèªã‚’å¾…ãŸãšã«ã€ã™ãã«Destroyã‚’å®Ÿè¡Œ
          echo "State unlocked. Starting immediate destroy..."
          terraform destroy -auto-approve
        
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}