name: ğŸ”‘ Manual State Unlock (Temporary)

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨

jobs:
  unlock:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # deploy.ymlã‚„destroy.ymlã¨åŒã˜IAMãƒ­ãƒ¼ãƒ«ã®ARNã‚’æŒ‡å®š
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          
      - name: Terraform Init
        # â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: -lock=false ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ  â˜…â˜…â˜…
        run: terraform init -lock=false 
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}

      # â˜…â˜…â˜… ãƒ­ãƒƒã‚¯è§£é™¤ã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ­ãƒƒã‚¯IDã‚’ç›´æ›¸ãï¼‰ â˜…â˜…â˜…
      - name: Force Unlock State
        # ãƒ­ãƒƒã‚¯ID: 3ae2ccf7-4724-be2b-400b-a17e00ac2b1c ã‚’ä½¿ç”¨
        run: terraform force-unlock -force 3ae2ccf7-4724-be2b-400b-a17e00ac2b1c
        working-directory: ./infra