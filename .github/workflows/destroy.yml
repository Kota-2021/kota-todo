name: ğŸš¨ Manual Destroy Environment

on:
  workflow_dispatch: # â˜…æ‰‹å‹•ã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹â˜…
    inputs:
      confirm:
        description: 'Type "DESTROY" to confirm the action. WARNING: This will delete all infrastructure except S3 backend.'
        required: true
        default: 'NO'

jobs:
  destroy:
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "DESTROY" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'DESTROY'
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    environment: production # ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šå¯èƒ½
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. ãƒ­ãƒ¼ã‚«ãƒ«ã®Terraformãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…¨ã¦å‰Šé™¤
    - name: ğŸ’£ Force Clean Local Terraform Cache
      run: |
        echo "Cleaning up local Terraform directories to reset environment..."
        rm -rf .terraform
        rm -f .terraform.lock.hcl
      working-directory: ./infra
        
    # 2. AWSèªè¨¼æƒ…å ±ã®å–å¾—
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
        aws-region: ap-northeast-1

    # 3. Terraformå®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.13.5
        
    # 4. Terraform Destroy ã®å®Ÿè¡Œ
    - name: ğŸ§¹ Execute Terraform Destroy
      run: |
        # åˆæœŸåŒ–ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãŒå¿…è¦ãªå ´åˆã¯ -reconfigure ã‚’ä½¿ç”¨ï¼‰
        terraform init -reconfigure
        
        echo "Running terraform destroy with refresh enabled..."
        # ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: -refresh=false ã‚’å‰Šé™¤ã—ã€æœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ ã•ã›ã¾ã™ã€‚
        # ã¾ãŸã€å¤‰æ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«ãƒ€ãƒŸãƒ¼å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚
        terraform destroy -auto-approve -input=false -var="app_image_uri=dummy"
      working-directory: ./infra
      env:
        TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}