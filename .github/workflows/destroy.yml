name: ğŸš¨ Manual Destroy Environment

on:
  workflow_dispatch: # â˜…æ‰‹å‹•ã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹â˜…
    inputs:
      confirm:
        description: 'Type "DESTROY" to confirm the action. WARNING: This will delete all infrastructure except S3 backend.'
        required: true
        default: 'NO'

jobs:
  destroy:
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "DESTROY" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'DESTROY'
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    environment: production # ğŸš¨ ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šå¯èƒ½
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWSèªè¨¼æƒ…å ±ã®å–å¾— (OIDCèªè¨¼)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      # 2. Terraformå®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          
      # 3. Terraform Init ã®å®Ÿè¡Œ
      - name: Terraform Init
        run: terraform init
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }} # RDSãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯Initæ™‚ã«ã‚‚å¿…è¦

      # â˜…â˜…â˜… ä¸€æ™‚çš„ã«è¿½åŠ ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ— â˜…â˜…â˜…
      - name: Force Unlock State
        # -force ãƒ•ãƒ©ã‚°ã§ãƒ­ãƒƒã‚¯ã‚’å¼·åˆ¶è§£é™¤
        run: terraform force-unlock -force 3ae2ccf7-4724-be2b-400b-a17e00ac2b1c
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }} 
      # â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…

      # 4. Terraform Destroy ã®å®Ÿè¡Œ
      - name: Terraform Destroy All Except S3 Backend
        # S3ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‹ã‚‰å¤–ã™ãƒ­ã‚¸ãƒƒã‚¯ã¯Terraformå´ã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å˜ç´”ãªDestroyã‚’å®Ÿè¡Œ
        run: terraform destroy -auto-approve
        working-directory: ./infra
        env:
          # Destroyæ™‚ã«ã‚‚ä¸€éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãŒå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ãŸã‚æ¸¡ã™
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}