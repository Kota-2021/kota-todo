name: CI/CD Pipeline

on:
  push:
    branches:
      - main # mainブランチへのプッシュをトリガーにする

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions: # OIDC認証に必要な権限
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWS認証情報の取得 (OIDC認証)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1
      
      # 2. ECRへのログイン（Dockerクライアントを認証）
      - name: Login to Amazon ECR
        id: login-ecr # 後続のビルド・プッシュステップでレジストリURLを参照するためにIDを設定
        uses: aws-actions/amazon-ecr-login@v2

      # 3. Go環境のセットアップ (新規追加)
      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4' # プロジェクトで使用しているGoのバージョンに合わせてください
      
      # 4. アプリケーションのテスト (新規追加)
      - name: Run Unit Tests
        run: go test -v ./...
      
      # 5 & 6. Dockerイメージのビルド、タグ付け、およびECRへのプッシュ
      # 5. Dockerイメージのビルドとタグ付け
      # （ステップ6に相当）ECRへプッシュ
      - name: Build, tag, and push docker image to Amazon ECR
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025 # プロジェクトのリポジトリ名に合わせてください
          IMAGE_TAG: ${{ github.sha }} # コミットSHAをタグに使用
        run: |
          echo "Building image with tag: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
       
          echo "Pushing image to ECR..."
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          
      # 7. Terraform実行環境のセットアップ
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      # 8. Terraform Init の実行 (S3バックエンド設定が必要)
      - name: Terraform Init
        env:
          # GitHub Secretsからパスワードを取得し、TF_VAR_として設定
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        run: terraform init
      
      # 9. Terraform Plan の実行 (ECSタスク定義のイメージURIを更新)
      # run-1. 完全なイメージURIを構築
      # run-2. イメージURIをワークフローの環境変数として保存 (Applyステップで使用するため)
      # run-3. ECSタスク定義のイメージURIを変数としてPlanに渡す
      - name: Terraform Plan
        id: plan
        env:
          # ECRプッシュステップで使用した環境変数を再利用
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI="$REGISTRY/$REPOSITORY:$IMAGE_TAG"
          
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
          terraform plan -no-color -input=false \
            -var="app_image_uri=$IMAGE_URI" \
            -out=tfplan

      # 10. Terraform Apply の実行
      - name: Terraform Apply
        env:
          # Secretsを再度envに渡す
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
        # Planステップで設定した環境変数 IMAGE_URI をここで参照します
        run: terraform apply -auto-approve -input=false \
          -var="app_image_uri=${{ env.IMAGE_URI }}" tfplan