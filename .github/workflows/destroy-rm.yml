name: ğŸš¨ Manual Destroy-Remove Environment

on:
  workflow_dispatch: # â˜…æ‰‹å‹•ã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹â˜…
    inputs:
      confirm:
        description: 'Type "DESTROY-RM" to confirm the action. WARNING: This will delete all infrastructure except S3 backend.'
        required: true
        default: 'NO'

jobs:
  destroy-rm:
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "DESTROY-RM" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'DESTROY-RM'
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    environment: production # ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šå¯èƒ½
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWSèªè¨¼æƒ…å ±ã®å–å¾— (OIDCèªè¨¼)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      # 2. Terraformå®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          
      # 3. Terraform Init ã®å®Ÿè¡Œ
      - name: Terraform Init
        run: terraform init
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }} # RDSãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯Initæ™‚ã«ã‚‚å¿…è¦
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
      
      # 4. Terraform State Remove ã®å®Ÿè¡Œ
      # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€Stateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç‰©ç†ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
      # â€»ã¾ãšå…ˆã«ã€lookstate.ymlã‚’å®Ÿè¡Œã—ã€Stateãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚ãã—ã¦ãã®ãƒªã‚¹ãƒˆã«ã‚ã‚‹ç‰©ç†ãƒªã‚½ãƒ¼ã‚¹ã«åˆã†ã‚ˆã†ã«ã€ä¸‹è¨˜rmã‚³ãƒãƒ³ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
      - name: Terraform State Remove
        run: |
          echo "Starting state cleanup (removing all tracked resources from state file)..."
          
          # ç‰©ç†ãƒªã‚½ãƒ¼ã‚¹ã® State ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™

          # Route 53 ãƒ¬ã‚³ãƒ¼ãƒ‰
          terraform state rm aws_route53_record.root
          
          # ALB HTTPS ãƒªã‚¹ãƒŠãƒ¼
          terraform state rm aws_lb_listener.https

          # aws_cloudwatch_log_group.ecs
          terraform state rm aws_cloudwatch_log_group.ecs
          
          # aws_ecr_lifecycle_policy.main ã¯ aws_ecr_repository.main ãŒå‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã‚Œã‚‚å‰Šé™¤
          terraform state rm aws_ecr_lifecycle_policy.main
          
          # ECS/Task Definition
          terraform state rm aws_ecs_task_definition.main
          
          # ElastiCache (Redis)
          terraform state rm aws_elasticache_cluster.main
          terraform state rm aws_elasticache_subnet_group.main
          
          # IAM Roles/Policies/Instance Profile
          terraform state rm aws_iam_instance_profile.ssm_instance
          terraform state rm aws_iam_policy.ecs_secrets_policy
          terraform state rm aws_iam_role.ecs_task
          terraform state rm aws_iam_role.ecs_task_execution
          terraform state rm aws_iam_role.ssm_instance
          terraform state rm aws_iam_role_policy.ecs_task_sqs
          terraform state rm aws_iam_role_policy_attachment.ecs_secrets_attachment
          terraform state rm aws_iam_role_policy_attachment.ecs_task_execution_ecr
          terraform state rm aws_iam_role_policy_attachment.ssm_managed_instance
          
          # EC2/Bastion
          terraform state rm aws_instance.ssm_bastion

          # ALB/VPC/Networking (VPCã‚„IGWã¯ä¾å­˜é–¢ä¿‚ã§æœ€å¾Œã«å‰Šé™¤ã•ã‚Œã‚‹ã¹ãã§ã™ãŒã€State RMãªã‚‰å•é¡Œã‚ã‚Šã¾ã›ã‚“)
          terraform state rm aws_lb.main
          terraform state rm aws_lb_listener.http
          terraform state rm aws_lb_target_group.main
          terraform state rm aws_eip.nat_a
          terraform state rm aws_nat_gateway.a
          terraform state rm aws_internet_gateway.main
          
          # Route Tables / Associations
          terraform state rm aws_route_table.private_a
          terraform state rm aws_route_table.public
          terraform state rm aws_route_table_association.private_a
          terraform state rm aws_route_table_association.private_b
          terraform state rm aws_route_table_association.public_a
          terraform state rm aws_route_table_association.public_b
          
          # Security Groups / Rules
          terraform state rm aws_security_group.alb
          terraform state rm aws_security_group.ecs_fargate
          terraform state rm aws_security_group.rds
          terraform state rm aws_security_group.redis
          terraform state rm aws_security_group.ssm_bastion
          terraform state rm aws_security_group_rule.rds_inbound_bastion
          
          # SQS
          terraform state rm aws_sqs_queue.dlq
          terraform state rm aws_sqs_queue.main
          terraform state rm aws_sqs_queue_redrive_policy.main_queue_redrive_policy
          
          # Subnets / VPC (æœ€å¾Œã«æ®‹ã‚Šã®VPCã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‰Šé™¤)
          terraform state rm aws_subnet.private_a
          terraform state rm aws_subnet.private_b
          terraform state rm aws_subnet.public_a
          terraform state rm aws_subnet.public_b
          terraform state rm aws_vpc.main

          echo "State cleanup complete. State file is now empty (except for data sources)."
        
        working-directory: ./infra
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}