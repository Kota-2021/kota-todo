name: ▶️ CI/CD Pipeline

on:
  ## 本番環境ではpushの3行を使用する
  # push:
  #   branches:
  #     - main
  ## 開発のみでは以下のworkflow_dispatchの6行を使用する
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm the action.'
        required: true
        default: 'NO'

jobs:
  deploy:
    ## 本番環境ではifの行は削除する事。onのpushの3行を使用し、自動実行を有効にする。
    # ユーザーが "DEPLOY" と入力した場合のみ実行
    if: github.event.inputs.confirm == 'DEPLOY'
    runs-on: ubuntu-latest
    
    # --- [テスト用]の DB と Redis を GitHub Actions 上に起動 ---
    services:
      postgres:
        image: postgres:17.6
        env:
          POSTGRES_USER: portfolio_admin
          POSTGRES_DB: portfolio_db
          POSTGRES_PASSWORD: local_dev_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: sqs
          DEFAULT_REGION: ap-northeast-1
          DEBUG: 1
    # --- [テスト用]ここまで ---

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. AWS認証情報の取得 (OIDC認証)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
          aws-region: ap-northeast-1

      # ----------------------------------------------------
      # 【修正箇所 1】コアインフラ構築をDocker操作の前に実行
      # ----------------------------------------------------

      # 2. Terraform実行環境のセットアップ (元のステップ7を移動)
      - name: Setup Terraform (Core Infra)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      # 3. Terraform Init の実行 (元のステップ8を移動)
      - name: Terraform Init (Core Infra)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
        run: terraform init
        working-directory: ./infra
      
      # 4. Terraform Apply (コアインフラ構築: ECR, SQSなど) の実行 (新規追加)
      # Docker Pushに必要なECRリポジトリと、W4-D16のタスクに必要なSQSキューを先に作成します。
      # -target は、既に存在しているリソースのエラー（前回発生したTarget Groupなどのエラー）を一時的に回避するためにも有効です。
      - name: Terraform Apply (Core Infra ECR, SQS)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
        run: |
          echo "Applying core infrastructure: ECR and SQS..."
          terraform apply -auto-approve -input=false
        working-directory: ./infra
      
      # ----------------------------------------------------
      # 【修正箇所 2】アプリケーションのビルド・デプロイ (ECRが存在するため成功する)
      # ----------------------------------------------------
      
      # 5. ECRへのログイン（元ステップ2）
      - name: Login to Amazon ECR
        id: login-ecr 
        uses: aws-actions/amazon-ecr-login@v2

      # 6. Go環境のセットアップ（元ステップ3）
      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
        
      # --- テスト実行前に LocalStack 内にキューを作成する ---
      - name: Create SQS Queue in LocalStack
        run: |
          # localstack が起動するのを少し待機
          sleep 5
          # AWS CLIを使って、テストコードが期待している名前のキューを作成
          aws sqs create-queue --queue-name portfolio-notifications --endpoint-url http://localhost:4566 --region ap-northeast-1
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: ap-northeast-1

      # 7. アプリケーションのテスト（元ステップ4）
      - name: Run Unit Tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: portfolio_admin
          DB_PASSWORD: local_dev_password
          DB_NAME: portfolio_db
          DB_SSLMODE: disable
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          # --- SQSの接続先を LocalStack に向ける ---
          SQS_QUEUE_URL: http://localhost:4566/000000000000/portfolio-notifications
          AWS_REGION: ap-northeast-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          JWT_SECRET: "test-secret-key-for-ci"
        run: go test -v ./...
        
      # 8. Dockerイメージのビルド、タグ付け、およびECRへのプッシュ（元ステップ5&6）
      # ECRリポジトリがステップ4で作成されているため、このステップは成功します。
      - name: Build, tag, and push docker image to Amazon ECR
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building image with tag: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
        
          echo "Pushing image to ECR..."
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          
      # ----------------------------------------------------
      # 【修正箇所 3】ECSサービス更新 (Terraform Plan & Apply)
      # ----------------------------------------------------

      # 9. Terraform Plan の実行 (ECSタスク定義のイメージURIを更新) (元ステップ9)
      - name: Terraform Plan (Service Update)
        id: plan
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: my-portfolio-2025
          IMAGE_TAG: ${{ github.sha }}
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
        run: |
          IMAGE_URI="$REGISTRY/$REPOSITORY:$IMAGE_TAG"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
          # app_image_uri変数を使用して、ECSタスク定義のイメージURIを更新するPlanを作成
          terraform plan -no-color -input=false \
            -var="app_image_uri=$IMAGE_URI" \
            -out=tfplan
        working-directory: ./infra

      # 10. Terraform Apply の実行 (ECSサービスの更新) (元ステップ10)
      - name: Terraform Apply (Service Update)
        env:
          TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
        # 作成したPlanファイルを適用し、ECSサービスをデプロイ
        run: terraform apply -auto-approve -input=false tfplan
        working-directory: ./infra