name: ğŸš¨ Manual Destroy Environment

on:
  workflow_dispatch: # â˜…æ‰‹å‹•ã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹â˜…
    inputs:
      confirm:
        description: 'Type "DESTROY" to confirm the action. WARNING: This will delete all infrastructure except S3 backend.'
        required: true
        default: 'NO'

jobs:
  destroy:
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "DESTROY" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'DESTROY'
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    environment: production # ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šå¯èƒ½
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. ãƒ­ãƒ¼ã‚«ãƒ«ã®Terraformãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…¨ã¦å‰Šé™¤
    - name: ğŸ’£ Force Clean Local Terraform Cache
      run: |
        echo "Cleaning up local Terraform directories to reset environment..."
        rm -rf .terraform
        rm -f .terraform.lock.hcl
      working-directory: ./infra
        
    # 2. AWSèªè¨¼æƒ…å ±ã®å–å¾—
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Terraform-Deployer
        aws-region: ap-northeast-1

    # 3. Terraformå®Ÿè¡Œç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.13.5
        
    # 4. Stateãƒ•ã‚¡ã‚¤ãƒ«ã®å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: ğŸ§¹ Final State Cleanup and Verification
      run: |
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šã®å†é©ç”¨ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãŸã‚ï¼‰
        terraform init -force-copy
        
        # AWSã¸ã®å•ã„åˆã‚ã›ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦Stateãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
        echo "Running destroy with -refresh=false to clear any lingering State entries..."
        # 20251129byKota â€»ã“ã“ã§ã¯ã€app_image_uriã‚’ç©ºã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ECSã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚¤ãƒ¡ãƒ¼ã‚¸URIã‚’ç©ºã«ã™ã‚‹ãŸã‚ã§ã™ã€‚
        terraform destroy -auto-approve -refresh=false -var="app_image_uri="
        
      working-directory: ./infra
      env:
        TF_VAR_db_password: ${{ secrets.DB_MASTER_PASSWORD }}